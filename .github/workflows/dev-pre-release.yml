name: Dev Pre-Release

on:
  push:
    branches: [develop]
    paths:
      - 'apps/mobile/**'
      - '.github/workflows/dev-pre-release.yml'

concurrency:
  group: dev-pre-release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build-debug-apk:
    name: Build Debug APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build debug APK
        working-directory: apps/mobile
        run: ./gradlew assembleDebug -PdevBuildNumber=${{ github.run_number }}

      - name: Extract version
        id: version
        working-directory: apps/mobile
        run: |
          VERSION=$(grep 'val appVersionName' app/build.gradle.kts | sed 's/.*"\(.*\)".*/\1/')
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Extracted version '$VERSION' does not look like semver"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Rename APKs
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RUN="${{ github.run_number }}"
          PHONE_SRC="apps/mobile/app/build/outputs/apk/debug/app-debug.apk"
          WEAR_SRC="apps/mobile/wear/build/outputs/apk/debug/wear-debug.apk"

          mkdir -p dist
          if [ -f "$PHONE_SRC" ]; then
            cp "$PHONE_SRC" "dist/GlycemicGPT-${VERSION}-dev.${RUN}-debug.apk"
          fi
          if [ -f "$WEAR_SRC" ]; then
            cp "$WEAR_SRC" "dist/GlycemicGPT-Wear-${VERSION}-dev.${RUN}-debug.apk"
          fi

          # Verify at least one APK was produced
          if ! ls dist/*.apk >/dev/null 2>&1; then
            echo "ERROR: No APK files found in dist/"
            exit 1
          fi

      - name: Publish dev-latest pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RUN="${{ github.run_number }}"
          COMMIT="${{ github.sha }}"
          SHORT_SHA="${COMMIT:0:7}"

          # Delete existing release+tag, then immediately recreate (single step to reduce window)
          gh release delete dev-latest --yes --cleanup-tag 2>/dev/null || true
          gh release create dev-latest \
            --title "Dev Build ${VERSION}-dev.${RUN}" \
            --notes "Development build from \`develop\` branch.

          **Version:** ${VERSION}-dev.${RUN}
          **Commit:** ${SHORT_SHA}
          **Branch:** develop

          > This is an unstable development build. Use the [latest stable release](/releases/latest) for production use." \
            --prerelease \
            --target develop \
            dist/*.apk
